---
title: Update on the conditioning of an operating model for the Indian Ocean swordfish
author: Iago Mosqueira, Daniela Rosa, Dan Fu, Rui Coelho.
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: yes
tags:
abstract:
header-includes: 
  - \usepackage{float}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \fancyhead{}
  - \fancyhead[L]{Mosqueira et al. - Swordfish OM}
  - \fancyhead[R]{IOTC-2017-SC21-XX}
license: Creative Commons Attribution-ShareAlike 4.0 International Public License
---

```{r, knitr, echo=FALSE, message=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE,
  fig.width=5, fig.height=3, fig.pos='H')
```

# Introduction


## Background

The Indian Ocean Tuna Commission (IOTC) has committed to a path of using Management Strategy Evaluation (MSE) to meet its obligations for adopting the precautionary approach. IOTC Resolution 12/01 "On the implementation of the precautionary approach" identifies the need for fishery reference points and harvest strategies to help maintain stocks at levels consistent with the reference points. Resolution 15/10, that superseded Resolution 13/10, provided a renewed mandate for the Scientific Committee to evaluate the performance of harvest control rules with respect to the species-specific interim target and limit reference points, no later than 10 years following the adoption of the reference points, for consideration of the Commission and their eventual adoption. A species-specific workplan was re-affirmed at the 2017 Commission Meeting, outlining the steps required to adopt simulation-tested Management Procedures for the highest priority species (included in Attachment 1). Recognizing the iterative nature of the MSE process, the workplan identifies 2019 as the earliest probable date for MP adoption.

## SWO assessment

A new swordfish stock assessment was undertaken in 2017 using stock synthesis (SS3) with fisheries data up to 2015. The assessment used a spatially disaggregated, sex explicit and age structured model. The model indicated that MSY-based reference points for the last years were not exceeded for the Indian Ocean population as a whole (F2015/FMSY<1 & SB2015/SBMSY>1). Spawning stock biomass in 2015 was estimated to be 26-43% of the unfished levels. Biomass started declining mainly since the early 1990â€™s as catches increased in that period, and have been declining more slowly since then, as F levels have also been reduced (Figure ??).

ADD FIGURE WITH 2017 SA RESULTS


# Structural uncertainty grid
The initial strategy to follow for the development of the SWO MSE platform were discussed by the WPM in 2017 (IOTC 2017a). It was agreed to use the stock assessment carried out and reviewed by the WPB in 2017 (IOTC 2017b) based on SS3 - Stock Synthesis 3.24z - CHECK VERSION (Methot and Wetzel 2013), as a basis for the population and fishery model to build the OM for this stock. Uncertainties concerning structural elements of the model formulation were considered to be the primary factor of concern.

The WPM proposed an initial grid of options for characterizing the structure of the uncertainty grid for generating the OM, based on a set of SS3 model runs (IOTC 2017a). During the 1st workshop meeting of the authors to start the conditioning of the OM, those were discussed. The decision was to construct a grid of model runs built around those suggested by the WPB on feasible, or at least not too extreme, values for a number of assumptions and fixed parameters in the population model. The impact of some of these elements in the model were already explored in some detail by the researchers carrying out past stock assessments (Fu, 2017).

The main points relevant to this preliminary OM are:
  i. OM-reference (OM-ref) derived from the 2017 SS3 SWO assessment model (SA-base) used for management advice;
  ii. Uncertainty in the OM grid as discussed below and shown further down in Table XX.


## Selectivity
Two distributions were considered for the fleets selectivity:

* Double Normal
* Logistic


## Steepness
Steepness (h) from Beverton and Holt stock-recruitment function is often a very influential parameter which is difficult to estimate or characterize in most stock assessments. The base case SA models used 0.75, and the other options (0.6 and 0.9) reflect plausible uncertainty with lower and higher values. Three values for steepness were used:

* 0.6
* 0.75
* 0.9


## Growth & Maturity
Growth and maturity are very important parameters in stock assessments. Swordfish exhibit  a marked difference in growth between male and female, therefore sex-specific growth and maturity estimates are used. There are concerns in the age estimation of swordfish, with differences being found between the structures used to estimate age (fin rays or otoliths). This uncertainty also undermines the maturity by age relationship. Two growth curves and maturity estimates are considered for the preliminary OM:

* slow growth/late maturity  (Wang et al., 2010)
* fast growth/early maturity (Farley et al., 2016 - otoliths)

The Figures \ref{fig:maturity} and \ref{fig:growth}. below represent the options used for growth and maturity curves

```{r echo=FALSE, results=FALSE, message=FALSE, warnings=FALSE}
library(reshape)
library(ggplot2)
Farley.2016.otolith <- c(0.001, 0.006, 0.027, 0.109, 0.354, 0.711, 0.917, 0.98, 0.996, 0.999,   1, 1, 1, 1, 1, 1, 1, 1, 1,
                         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
Wang.2010 <- c(0, 0, 0, 0, 0.02, 0.1, 0.5, 0.9, 0.98, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1)
Mat.data <- data.frame(Farley.2016.otolith=Farley.2016.otolith, Wang.2010=Wang.2010)
Mat.data.melt <- melt(Mat.data)
Mat.data.melt$Age <- seq(0,30) # Add ages vector
Mat.plot <-ggplot(data=Mat.data.melt)+
  geom_line(aes(x=Age, y=value, group=variable, color=variable), size=1)+
  geom_point(aes(x=Age, y=value, group=variable, color=variable), size=2)+
  xlim(0, 15)+ 
  labs(title = "Age-at-Maturity", x = "Age", y = "Proportion mature")+
  guides(color=guide_legend("Maturity curve"))+ 
  theme_bw()
```

```{r maturity, fig.cap=c("\\label{fig:maturity}Age-at-maturity options for conditioning the SWO OM")}
print(Mat.plot)
```

```{r echo=FALSE, results=FALSE, message=FALSE, warnings=FALSE}
library(reshape)
library(ggplot2)
Farley.2016.oto.F <- c(83.70591021,	111.6181888,	135.4749267,	155.8653773,	173.2931783,	188.1887905,	200.9201307,	211.8016588,
                       221.1021451,	229.0513084,	235.8454906,	241.6525057,	246.6157851,	250.8579201,	254.4836901,	257.5826505,
                       260.2313445,	262.495194,	264.4301154,	266.0839005,	267.4973974,	268.7055189,	269.7381053,	270.620661,
                       271.374985,	272.0197088,	272.5707568,	273.0417398,	273.4442908,	273.7883529,	274.0824241)
Farley.2016.oto.M <- c(87.79367093,	114.1762607,	135.0335671,	151.5227456,	164.5586094,	174.8643833,	183.0118278,	189.4529599,
                       194.5451311,	198.5708533,	201.7534719,	204.2695574,	206.2587012,	207.8312603,	209.0744797,	210.0573328,
                       210.8343477,	211.4486331,	211.9342692,	212.3181989,	212.6217226,	212.8616796,	213.0513826,	213.2013562,
                       213.319921,	213.4136549,	213.4877581,	213.546342,	213.5926567,	213.6292718,	213.6582186)
Wang.2010.spines.F <- c(66.23390044,	93.1254331,	116.550612,	136.9562547,	154.7315834,	170.215649,	183.7037982,	195.4533074,
                        205.6882894,	214.6039689,	222.3704056,	229.1357385,	235.0290111,	240.1626332,	244.6345247,
                        248.5299835,	251.9233125,	254.8792371,	257.454139,	259.6971328,	261.6510017,	263.3530143,
                        264.8356353,	266.1271446,	267.2521765,	268.2321904,	269.0858793,	269.8295265,	270.4773166,
                        271.0416057,	271.5331572)
Wang.2010.spines.M <- c(72.14055972,	97.30857257,	118.5631835,	136.5128917,	151.67158,	164.4732273,	175.2843324,	184.4144069,
                        192.1248362,	198.6363623,	204.1354041,	208.7793938,	212.7012845,	216.0133561,	218.8104301,	221.172584,
                        223.1674439,	224.8521209,	226.2748457,	227.4763494,	228.4910299,	229.3479367,	230.0716021,	230.682744,
                        231.1988588,	231.6347223,	232.0028129,	232.3136687,	232.5761892,	232.7978901,	232.9851184)

Age.data <- data.frame(Farley.2016.oto.F=Farley.2016.oto.F, Farley.2016.oto.M=Farley.2016.oto.M, Wang.2010.spines.F=Wang.2010.spines.F,
                       Wang.2010.spines.M=Wang.2010.spines.M)
Age.data.melt <- melt(Age.data)
Age.data.melt$Age <- seq(0,30) # Add ages vector
Age.plot <-ggplot(data=Age.data.melt)+
  geom_line(aes(x=Age, y=value, group=variable, color=variable), size=1)+
  geom_point(aes(x=Age, y=value, group=variable, color=variable), size=2)+
  xlim(0, 30)+ 
  labs(title = "Growth", x = "Age", y = "Size (LJFL, cm)")+
  guides(color=guide_legend("Growth curve"))+ 
  theme_bw()
```

```{r growth, fig.cap=c("\\label{fig:growth}Growth curve options for conditioning the SWO OM")}
print(Age.plot)
```


## Natural Mortality M)
Natural mortality is a common unknown in most stock assessment models. The base case considered in the stock assessment model was 0.2 constant for all ages, which was supplemented with an alternative value of 0.4 also constant for all ages as suggested by the WPM. Additionally, after some additional considerations on the use of fixed versus age-specific M, the authors also decided to add a 3rd possibility using age-specific M values, based on the the Lorenzen equation. A total of 3 possibilities were therefore considered for M in this preliminary model grids:

* 0.2, constant for all ages
* 0.4, constant for all ages
* Age and sex specific values based on the Lorenzen equation

The Figure \ref{fig:mortality} below represents the options used for M  

```{r echo=FALSE, results=FALSE, message=FALSE, warnings=FALSE}
library(reshape)
library(ggplot2)
Low <- rep(0.2, 31)
High <- rep(0.4, 31)
Lorenzen.F <- c(0.5660322,	0.4382228,	0.368445,	0.3248203,	0.295235,	0.2740602,	0.2583189,	0.2462855,	0.23689,
                0.2294327,	0.2234366,	0.2185649,	0.2145735,	0.2112806,	0.2085487,	0.2062716,	0.204366,	0.2027662,
                0.2014195,	0.2002831,	0.1993224,	0.1985089,	0.1978191,	0.1972334,	0.1967357,	0.1963124,	0.1959521,
                0.1956453,	0.1953838,	0.1951609,	0.1949708)
Lorenzen.M <- c(0.4588258,	0.3631227,	0.3124604,	0.2817323,	0.2615569,	0.2476183,	0.2376487,	0.2303405,	0.2248866,
                0.220762,	0.2176113,	0.2151861,	0.2133084,0.2118481,	0.2107082,	0.2098161,	0.2091164,	0.2085667,
                0.2081342,	0.2077936,	0.2075252,	0.2073135,	0.2071465,	0.2070146,	0.2069105,	0.2068282,	0.2067633,
                0.2067119,	0.2066714,	0.2066393,	0.206614)
M.schedules.data <- data.frame(Low=Low, High=High, Lorenzen.F=Lorenzen.F, Lorenzen.M=Lorenzen.M)
M.schedules.data.melt <- melt(M.schedules.data)
M.schedules.data.melt$Age <- seq(0,30) # Add ages vector
M.schedules.plot <-ggplot(data=M.schedules.data.melt)+
  geom_line(aes(x=Age, y=value, group=variable, color=variable), size=1)+
  geom_point(aes(x=Age, y=value, group=variable, color=variable), size=2)+
  labs(title = "Natural Mortality", x = "Age", y = "M")+
  guides(color=guide_legend("M option"))+ 
  theme_bw()
```

```{r mortality, fig.cap=c("\\label{fig:mortality}Natural mortality options for conditioning the SWO OM")}
print(M.schedules.plot)
```


## Efective Sampling Size (ESS)
Two values were used for the relative weight of length sampling data in the total likelihood, through changes in the efective sampling size parameter, of 2 and 20. This alters the relative weighting of length samples and CPUE series in informing the model about stock dynamics and the effects of fishing at length. The values of ESS used in the model grid were therefore:

* 2
* 20


## CPUE series
CPUE series presented to the WPB showed conflicting trends, the base case considered in the assessment used the Japanese late (1994-2015) CPUE with Portuguese indices from 2000-2015 being used in the Southwest. A total of 3 possibilities are considered for CPUE in this preliminary model grid, based on suggestions from the WPM:

* JPNlate+EU.PRT: Japanese CPUE (1994-2015) with indices 2000-2015 in the SW replaced by Portuguese index,
* JPNlate: Japanese CPUE (1994-2015),
* TWN+EU.PRT: Taiwanese CPUE (1994-2015) with indices 2000-2015 in the SW replaced by Portuguese index.

The Figure \ref{fig:CPUEs} below represents the options used for CPUE indexes  

```{r echo=FALSE, results=FALSE, message=FALSE, warnings=FALSE}
library(ioswomse)
library(stringr)
data(cpues)
#subset CPUES used
cpues.scenario1 <- subset(cpues, cpues$name=="UJPLL_NE"|cpues$name=="UJPLL_NW"|
                            cpues$name=="UJPLL_SE"|cpues$name=="UPOR_SW")
cpues.scenario1$option <- "CPUE.option1"
cpues.scenario2 <- subset(cpues, cpues$name=="UJPLL_NE"|cpues$name=="UJPLL_NW"|
                           cpues$name=="UJPLL_SE"|cpues$name=="UJPLL_SW")
cpues.scenario2$option <- "CPUE.option2"
cpues.scenario3 <- subset(cpues, cpues$name=="UTWLL_NE"|cpues$name=="UTWLL_NW"|
                            cpues$name=="UTWLL_SE"|cpues$name=="UPOR_SW")
cpues.scenario3$option <- "CPUE.option3"
cpues.grid <- rbind(cpues.scenario1, cpues.scenario2, cpues.scenario3)
#extract areas
cpues.grid$area <- str_sub(cpues.grid$name,-2,-1)
#extract fleets
cpues.grid$fleet <- str_sub(cpues.grid$name, 1,5)
plot.cpues <- ggplot(cpues.grid)+
  geom_line(aes(x=year, y=obs, col=fleet), size=0.5)+
  labs(y = "Scaled index")+
  ggtitle("CPUE Series") +
  scale_x_continuous(breaks = seq(1990, 2015, by = 5))+
  theme_bw()+
  theme(legend.position="right")+
  guides(color=guide_legend("CPUEs"))+
  facet_wrap(~option+area, scales="free_y")
```

```{r CPUEs, fig.cap=c("\\label{fig:CPUEs}CPUE series options for conditioning the SWO OM"), fig.width=9, fig.height=6}
print(plot.cpues)
```


## CPUE scaling
The conducted stock assessment considered a stock with four areas. Possible alternatives considered for scaling the CPUES were considered, noting that some options were already explored by the WPB during the stock assessment session and recommended by the WPM:

* area effect * surface
* Catch
* Biomass


## Catchability increase
Two scenarios were considered for the efective catchability of the CPUE fleet. On the first one it was assumed that the fleets have not improved their ability to fish for swordfish over time, or that any increase had been captured by the CPUE standardization process (0% increase). An alternative scenario considered a 1%/year increase in catchability by correcting the CPUE index to reflect this. The catchbility increase options considered therefore were:

* 0%
* 1%/year


## SigmaR
Two values were considered for the true variability of recruitment in the population (sigmaR), specifically 0.2 and 0.6, as set by the variable SR_sigmaR in the control file. The WPM discussed that both lower and higher options should be considered, but that a further middle value could also be added in the future (0.4). At this preliminary stage, and in order to not increase too much the grid of model runs, only the two extremes were considered for recruitment variability:

* SigmaR = 0.2
* SigmaR = 0.6

## Summary of the OM grid of uncertanties
Table \ref{tab-grid} summarizes the grid of uncertainties considered for the conditioning of the OM. This initial grid results in a total of XXXX models. 

```{r tab-grid, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
library(kableExtra)
library(knitr)
table_grid <-read.table("scripts/SWO-MSE-Uncertainty-grid.csv", header=T,sep=";")
table_grid <- table_grid[,1:4]
colnames(table_grid) <- c("Variables","Values","","")
kable(table_grid, "latex", booktabs=T, caption="Grid of uncertainties used for cinditioning the swordfish OM, based on the recomendations from the 2017 WPM") %>%
    kable_styling(full_width = F) %>%
  column_spec(1, width = "8em") %>%
  column_spec(2, width = "12em") %>%
  column_spec(3, width = "13em") %>%
  column_spec(4, width = "10em") %>%
  row_spec(0, bold = T)
```


# Software Implementation

The work presented here has been carried out using two main tools: the SS3 stock assessment platform (Methot and Wetzel 2013) for OM conditioning, and the FLR libraries (Kell et al. (2007), http://flr-project.org) for data input of OM model runs, assemblage of the base case OM, implementation and evaluation of the MPs, computational workload, and model output and summaries. The grid of model runs was constructed by altering for each factor combination the SS3 input files. Manipulation of these files was facilitated by the use of the r4ss R package. The setgrid function in the ioswomse package is responsible for carrying out the alterations for each element in grid as necessary. A generic R package, ss3om, has also been developed to load the results of the SS3 runs into FLR. Figure \ref{fig:workflow} below represents the workflow and packages used in this project

![Workflow and connections between the data, functions and packages used in the SWO MSE work \label{fig:workflow}](figures/ioswomse.png)



# Results

## OM conditioning

## Projections

- FLStock plot
- Histogram B0
- Conditional plots B0 ~ parameters

### Constant F=0

### Constant F2015

### Constant catch

# Discussion

## Next steps

# References

Fu, 2017 - SS3 SWO assessment

IOTC 2017a - WPM 2017 report

IOTC 2017b - WPB 2017 report

Methot, R.D.; Wetzel, C.R. 2013. Stock Synthesis: A Biological and Statistical Framework for Fish Stock Assessment and Fishery Management.
Fisheries Research 142, 86-99. 
